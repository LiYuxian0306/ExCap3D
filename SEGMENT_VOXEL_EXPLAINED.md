# Segment vs Instance å’Œä½“ç´ åŒ–è¯¦è§£

## 1. Segment å’Œ Instance çš„åŒºåˆ«

### **Segmentï¼ˆåˆ†å‰²å—ï¼‰**
- **å®šä¹‰**: ç‚¹äº‘çš„**å‡ ä½•/ç©ºé—´åˆ†å‰²**ï¼ŒåŸºäºç‚¹çš„ç©ºé—´é‚»è¿‘æ€§æˆ–è¡¨é¢è¿ç»­æ€§
- **ç‰¹ç‚¹**: 
  - çº¯å‡ ä½•åˆ†å‰²ï¼Œä¸è€ƒè™‘è¯­ä¹‰
  - ä¸€ä¸ªç‰©ä½“å¯èƒ½è¢«åˆ†æˆ**å¤šä¸ª segments**ï¼ˆä¾‹å¦‚æ¡Œå­å¯èƒ½æœ‰æ¡Œé¢segmentå’Œæ¡Œè…¿segmentï¼‰
  - å¯ä»¥é€šè¿‡ over-segmentation ç®—æ³•ç”Ÿæˆï¼ˆå¦‚ superpointã€felzenszwalb ç­‰ï¼‰
- **ä¾‹å­**: ä¸€æŠŠæ¤…å­å¯èƒ½è¢«åˆ†æˆï¼š
  - Segment 0: åº§é¢
  - Segment 1: é èƒŒ
  - Segment 2-5: å››æ¡è…¿

### **Instanceï¼ˆå®ä¾‹ï¼‰**
- **å®šä¹‰**: å®Œæ•´çš„**è¯­ä¹‰å¯¹è±¡**ï¼Œæ¯ä¸ªç‹¬ç«‹çš„ç‰©ä½“æ˜¯ä¸€ä¸ª instance
- **ç‰¹ç‚¹**:
  - å…·æœ‰è¯­ä¹‰æ„ä¹‰
  - ä¸€ä¸ª instance å¯ä»¥åŒ…å«**å¤šä¸ª segments**
  - éœ€è¦äººå·¥æ ‡æ³¨æˆ–ç®—æ³•é¢„æµ‹
- **ä¾‹å­**: åŒä¸€æŠŠæ¤…å­æ˜¯ä¸€ä¸ª instanceï¼Œå°½ç®¡å®ƒåŒ…å«å¤šä¸ª segments

### **å…³ç³»**
```
Instance (æ¤…å­1) 
  â”œâ”€ Segment 0 (åº§é¢çš„ç‚¹)
  â”œâ”€ Segment 1 (é èƒŒçš„ç‚¹)  
  â”œâ”€ Segment 2 (è…¿1çš„ç‚¹)
  â””â”€ Segment 3 (è…¿2çš„ç‚¹)

Instance (æ¤…å­2)
  â”œâ”€ Segment 4 (åº§é¢çš„ç‚¹)
  â””â”€ Segment 5 (é èƒŒçš„ç‚¹)
```

**åœ¨ä½ çš„ .npy æ–‡ä»¶ä¸­**:
- **åˆ— -3 (segment_id)**: å‡ ä½•åˆ†å‰²IDï¼Œç”± over-segmentation ç®—æ³•ç”Ÿæˆ
- **åˆ— -2 (semantic_label)**: è¯­ä¹‰ç±»åˆ«ï¼ˆæ¤…å­ã€æ¡Œå­ã€å¢™ç­‰ï¼‰
- **åˆ— -1 (instance_label)**: å®ä¾‹IDï¼ˆæ¤…å­1ã€æ¤…å­2ç­‰ï¼‰

---

## 2. ä½“ç´ åŒ– (Voxelization) è¯¦è§£

### **ä»€ä¹ˆæ˜¯ä½“ç´ åŒ–ï¼Ÿ**
ä½“ç´ åŒ–æ˜¯å°†**è¿ç»­çš„ 3D ç‚¹äº‘**è½¬æ¢ä¸º**ç¦»æ•£çš„ 3D ç½‘æ ¼**çš„è¿‡ç¨‹ï¼Œç±»ä¼¼äºå›¾åƒçš„åƒç´ åŒ–ã€‚

### **æ ¸å¿ƒä»£ç ä½ç½®**

#### æ–‡ä»¶: `datasets/utils.py`, è¡Œ 264-277
```python
# 1. å°†è¿ç»­åæ ‡ç¦»æ•£åŒ–åˆ°ä½“ç´ ç½‘æ ¼
coords = np.floor(sample[0] / voxel_size)  # â† å…³é”®æ“ä½œ

# 2. å»é™¤é‡å¤çš„ä½“ç´ åæ ‡
_, _, unique_map, inverse_map = ME.utils.sparse_quantize(**voxelization_dict)

# unique_map: ä»åŸå§‹ç‚¹åˆ°å”¯ä¸€ä½“ç´ çš„ç´¢å¼•
# åŸå§‹ç‚¹: [p0, p1, p2, p3, p4, ...]  (N points)
# ä½“ç´ :   [v0, v1, v2, ...]          (M voxels, M < N)
# unique_map[i] = å¯¹åº”çš„åŸå§‹ç‚¹ç´¢å¼•
```

### **è¯¦ç»†æµç¨‹**

å‡è®¾ `voxel_size = 0.02` (2cm):

**æ­¥éª¤ 1: è¿ç»­åæ ‡ â†’ ä½“ç´ ç´¢å¼•**
```python
# åŸå§‹ç‚¹äº‘åæ ‡ (è¿ç»­å€¼)
point_coords = [
    [0.013, 0.025, 0.001],  # point 0
    [0.018, 0.023, 0.002],  # point 1  â† å’Œ point 0 åœ¨åŒä¸€ä¸ªä½“ç´ å†…
    [0.045, 0.067, 0.003],  # point 2
]

# ä½“ç´ åŒ–: é™¤ä»¥ voxel_size å¹¶å‘ä¸‹å–æ•´
voxel_coords = np.floor(point_coords / 0.02)
# ç»“æœ:
# [0, 1, 0]  â† point 0
# [0, 1, 0]  â† point 1 (å’Œ point 0 ä¸€æ ·ï¼)
# [2, 3, 0]  â† point 2
```

**æ­¥éª¤ 2: å»é‡**
```python
# ä½¿ç”¨ sparse_quantize å»é™¤é‡å¤çš„ä½“ç´ åæ ‡
unique_voxels = [
    [0, 1, 0],  # voxel 0 (ä»£è¡¨ point 0 å’Œ point 1)
    [2, 3, 0],  # voxel 1 (ä»£è¡¨ point 2)
]

# unique_map = [0, 2]  â† é€‰æ‹© point 0 å’Œ point 2 ä½œä¸ºä»£è¡¨
# inverse_map = [0, 0, 1]  â† point 0,1 -> voxel 0; point 2 -> voxel 1
```

**æ­¥éª¤ 3: æ ‡ç­¾ä¹ŸåŒæ­¥å¤„ç†**
```python
# åŸå§‹ç‚¹çš„æ ‡ç­¾
original_labels = [
    [sem=3, inst=1, seg=5],  # point 0
    [sem=3, inst=1, seg=5],  # point 1
    [sem=8, inst=2, seg=12], # point 2
]

# ä½“ç´ åŒ–å (åªä¿ç•™ unique_map å¯¹åº”çš„ç‚¹)
voxel_labels = [
    [sem=3, inst=1, seg=5],   # voxel 0
    [sem=8, inst=2, seg=12],  # voxel 1
]
```

### **é…ç½®ä½ç½®**

**æ–‡ä»¶**: `conf/data/indoor.yaml`, çº¦ç¬¬ 30 è¡Œ
```yaml
voxel_size: 0.02  # 2cm çš„ä½“ç´ å¤§å°
```

**ä½ å¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹**: åœ¨ä½ çš„è®­ç»ƒé…ç½®ä¸­æœç´¢ `voxel_size`

---

## 3. ä½“ç´ åŒ–æ˜¯ç©ºé—´å†åˆ†å‰²å—ï¼Ÿ

### **ä¸å®Œå…¨æ˜¯ï¼Œä½†æœ‰ç›¸ä¼¼ä¹‹å¤„**

| å¯¹æ¯”ç»´åº¦ | Segmentï¼ˆé¢„å¤„ç†ï¼‰ | Voxelizationï¼ˆè®­ç»ƒæ—¶ï¼‰ |
|---------|-----------------|---------------------|
| **ç›®çš„** | å‡ ä½•åˆ†å‰²ï¼ˆover-segmentationï¼‰ | ä¸‹é‡‡æ ·ï¼ˆé™ä½è®¡ç®—é‡ï¼‰ |
| **æ–¹æ³•** | åŸºäºè¡¨é¢è¿ç»­æ€§/æ³•å‘é‡/é¢œè‰² | ç®€å•çš„ç©ºé—´ç½‘æ ¼åˆ’åˆ† |
| **ç»“æœ** | è¯­ä¹‰ç›¸å…³çš„å— | å‡åŒ€çš„ç©ºé—´å•å…ƒ |
| **ç²’åº¦** | ä¸è§„åˆ™ï¼Œè¯­ä¹‰ç›¸å…³ | è§„åˆ™ç½‘æ ¼ |

### **ç¤ºæ„å›¾**

```
åŸå§‹ç‚¹äº‘ (10000 points):
  ğŸ”´ğŸ”´ğŸ”´ğŸ”´ æ¤…å­
  ğŸ”µğŸ”µğŸ”µğŸ”µ æ¡Œå­

Segment åˆ†å‰² (é¢„å¤„ç†):
  Seg 0: ğŸ”´ğŸ”´ (æ¤…å­åº§é¢)
  Seg 1: ğŸ”´ğŸ”´ (æ¤…å­é èƒŒ)
  Seg 2: ğŸ”µğŸ”µ (æ¡Œé¢)
  Seg 3: ğŸ”µğŸ”µ (æ¡Œè…¿)

Voxelization (è®­ç»ƒæ—¶):
  ä½“ç´ ç½‘æ ¼ [2cm x 2cm x 2cm]:
  ğŸŸ¥ğŸŸ¦ ğŸŸ¥ğŸŸ¦  â† æ¯ä¸ªæ ¼å­æ˜¯ä¸€ä¸ªä½“ç´ 
  ğŸŸ¥ğŸŸ¦ ğŸŸ¥ğŸŸ¦
  (å¯èƒ½ 500 voxels)
```

---

## 4. ä½“ç´ å¤ªå°ä¼šå¯¼è‡´æ²¡æœ‰åˆé€‚çš„ instance å—ï¼Ÿ

### **ç­”æ¡ˆ: ä¼šï¼è¿™æ˜¯ä½ çš„é—®é¢˜çš„ä¸€ä¸ªå¯èƒ½åŸå› **

### **é—®é¢˜åœºæ™¯**

å‡è®¾ï¼š
- `voxel_size = 0.02` (2cm)
- æœ‰ä¸€ä¸ª**å¾ˆå°çš„ç‰©ä½“**ï¼Œä¾‹å¦‚ä¸€ä¸ªåªæœ‰ 200 ä¸ªç‚¹çš„å°è£…é¥°å“
- è¿™ 200 ä¸ªç‚¹åˆ†å¸ƒåœ¨ 10cm x 10cm x 5cm çš„ç©ºé—´å†…

**ä½“ç´ åŒ–å**:
```python
# 200 points -> å¯èƒ½åªå‰©ä¸‹ 15 voxels (å› ä¸ºå»é‡)

# åœ¨ get_instance_masks ä¸­:
if inst_mask.sum() < ignore_class_threshold:  # é»˜è®¤ 100
    continue  # â† è¢«è¿‡æ»¤ï¼
```

### **æ£€æŸ¥ä½ çš„é…ç½®**

**æ–‡ä»¶**: `check_dataset_complete.py`, ç¬¬ 7 è¡Œ
```python
def check_scene_validity(npy_path, 
                         voxel_size=0.02,  # â† è¿™é‡Œï¼
                         ignore_class_threshold=100,  # â† å’Œè¿™é‡Œï¼
```

**ä½ éœ€è¦ç¡®è®¤**:
1. å®é™…è®­ç»ƒé…ç½®ä¸­çš„ `voxel_size` æ˜¯å¤šå°‘ï¼Ÿ
   - æŸ¥çœ‹ `conf/data/indoor.yaml`
2. `ignore_class_threshold` æ˜¯å¤šå°‘ï¼Ÿ
   - æŸ¥çœ‹ `conf/config_base_instance_segmentation.yaml`

### **è§£å†³æ–¹æ¡ˆå»ºè®®**

å¦‚æœç¡®å®æ˜¯ä½“ç´ åŒ–å¯¼è‡´çš„é—®é¢˜ï¼š

**æ–¹æ¡ˆ 1: å¢å¤§ä½“ç´ å°ºå¯¸** (ä¸æ¨èï¼Œä¼šæŸå¤±ç²¾åº¦)
```yaml
# conf/data/indoor.yaml
voxel_size: 0.03  # ä» 2cm æ”¹ä¸º 3cm
```

**æ–¹æ¡ˆ 2: é™ä½è¿‡æ»¤é˜ˆå€¼** (æ¨è)
```yaml
# conf/config_base_instance_segmentation.yaml
general:
  ignore_class_threshold: 50  # ä» 100 é™ä½åˆ° 50
```

**æ–¹æ¡ˆ 3: åœ¨æ£€æŸ¥è„šæœ¬ä¸­ä½¿ç”¨ç›¸åŒçš„å‚æ•°**
```python
# check_dataset_complete.py
# ä¿®æ”¹ç¬¬ 7 è¡Œï¼Œä½¿ç”¨å’Œè®­ç»ƒé…ç½®ä¸€è‡´çš„å‚æ•°
def check_scene_validity(npy_path, 
                         voxel_size=0.02,  # â† ç¡®ä¿å’Œè®­ç»ƒé…ç½®ä¸€è‡´
                         ignore_class_threshold=100,  # â† ç¡®ä¿å’Œè®­ç»ƒé…ç½®ä¸€è‡´
```

---

## 5. å¦‚ä½•è°ƒè¯•

### **æ­¥éª¤ 1: æ‰¾å‡ºè®­ç»ƒæ—¶çš„å®é™…å‚æ•°**
```bash
# æŸ¥çœ‹ä½ çš„è®­ç»ƒé…ç½®
cat conf/data/indoor.yaml | grep voxel_size
cat conf/config_base_instance_segmentation.yaml | grep ignore_class_threshold
```

### **æ­¥éª¤ 2: æ›´æ–°æ£€æŸ¥è„šæœ¬**
æŠŠä¸Šé¢æ‰¾åˆ°çš„å‚æ•°å¡«å…¥ `check_dataset_complete.py`

### **æ­¥éª¤ 3: æ£€æŸ¥ä¸€ä¸ªå…·ä½“çš„ååœºæ™¯**
```python
# åœ¨ check_dataset_complete.py ä¸­æ·»åŠ è°ƒè¯•ä»£ç 
def check_scene_validity(npy_path, ...):
    # ... åŸæœ‰ä»£ç  ...
    
    # åœ¨è¿”å›å‰æ·»åŠ è¯¦ç»†ä¿¡æ¯
    print(f"Scene: {npy_path.name}")
    print(f"  Original points: {len(data)}")
    print(f"  After voxelization: {len(unique_coords)} voxels")
    print(f"  Raw instances: {len(instance_ids)}")
    print(f"  Valid instances: {valid_instances}")
    for reason in filtered_reasons:
        print(f"    - {reason}")
```

è¿™æ ·ä½ å°±èƒ½æ¸…æ¥šåœ°çœ‹åˆ°æ¯ä¸ªåœºæ™¯åœ¨ä½“ç´ åŒ–åå‘ç”Ÿäº†ä»€ä¹ˆã€‚
